<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GTA 2 Style Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--tg-theme-bg-color, #000);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è Telegram */
            padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: var(--tg-theme-secondary-bg-color, #222);
            cursor: crosshair;
            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è Telegram Web App */
            max-width: 100%;
            max-height: 100%;
        }
        
        #gameCanvas {
            display: block;
            outline: none;
            width: 100%;
            height: 100%;
        }
        
        #ui {
            position: absolute;
            top: max(10px, env(safe-area-inset-top, 0));
            left: max(10px, env(safe-area-inset-left, 0));
            color: var(--tg-theme-text-color, #fff);
            font-size: 16px;
            text-shadow: 2px 2px 0 var(--tg-theme-bg-color, #000);
            z-index: 10;
            user-select: none;
        }
        
        #controls {
            position: absolute;
            bottom: max(10px, env(safe-area-inset-bottom, 0));
            left: max(10px, env(safe-area-inset-left, 0));
            color: var(--tg-theme-text-color, #fff);
            font-size: 14px;
            background: var(--tg-theme-secondary-bg-color, rgba(0,0,0,0.7));
            padding: 10px;
            border-radius: 5px;
            user-select: none;
        }
        
        #location {
            position: absolute;
            top: max(10px, env(safe-area-inset-top, 0));
            right: max(120px, env(safe-area-inset-right, 0) + 120px);
            color: var(--tg-theme-text-color, #fff);
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 0 var(--tg-theme-bg-color, #000);
            user-select: none;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã */
        #mobileControls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            pointer-events: none;
            z-index: 20;
        }
        
        #joystick {
            position: absolute;
            width: 120px;
            height: 120px;
            bottom: 20px;
            left: 20px;
            pointer-events: auto;
        }
        
        #aimJoystick {
            position: absolute;
            width: 120px;
            height: 120px;
            bottom: 20px;
            right: 20px;
            pointer-events: auto;
        }
        
        #joystickBase, #aimJoystickBase {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
        }
        
        #aimJoystickBase {
            background: rgba(255,100,100,0.1);
            border: 2px solid rgba(255,100,100,0.3);
        }
        
        #joystickKnob, #aimJoystickKnob {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: none;
        }
        
        #aimJoystickKnob {
            background: rgba(255,100,100,0.5);
        }
        
        .mobileButton {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mobileButton:active {
            background: rgba(255,255,255,0.4);
        }
        
        
        #actionButton {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,255,0,0.3);
            border-color: rgba(0,255,0,0.5);
        }
        
        #weaponButton {
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255,255,0,0.3);
            border-color: rgba(255,255,0,0.5);
            font-size: 16px;
        }
        
        /* –°–∫—Ä—ã—Ç—å –º–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
        @media (hover: hover) and (pointer: fine) {
            #mobileControls {
                display: none;
            }
            #controls {
                display: block;
            }
        }
        
        /* –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        @media (hover: none) and (pointer: coarse) {
            #controls {
                display: none;
            }
            #mobileControls {
                display: block;
            }
            #gameContainer {
                cursor: default;
            }
        }
        
        .health {
            color: #ff4444;
            font-weight: bold;
        }
        
        .armor {
            color: #4444ff;
            font-weight: bold;
        }
        
        .money {
            color: #44ff44;
            font-weight: bold;
        }
        
        .wanted {
            color: #ffff44;
            font-weight: bold;
        }
        
        .weapon {
            color: #ff88ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div class="health">–ó–¥–æ—Ä–æ–≤—å–µ: <span id="health">100</span></div>
            <div class="armor">–ë—Ä–æ–Ω—è: <span id="armor">0</span></div>
            <div class="money">–î–µ–Ω—å–≥–∏: $<span id="money">0</span></div>
            <div class="wanted">–†–æ–∑—ã—Å–∫: <span id="wanted">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
            <div class="weapon">–û—Ä—É–∂–∏–µ: <span id="weapon">–ü–∏—Å—Ç–æ–ª–µ—Ç</span> [<span id="ammo">‚àû</span>]</div>
        </div>
        <div id="location">–¶–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞</div>
        <div id="controls">
            <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong><br>
            WASD - –î–≤–∏–∂–µ–Ω–∏–µ<br>
            E - –í–æ–π—Ç–∏/–í—ã–π—Ç–∏ –∏–∑ –º–∞—à–∏–Ω—ã<br>
            –õ–ö–ú - –°—Ç—Ä–µ–ª—å–±–∞<br>
            1-3 - –°–º–µ–Ω–∞ –æ—Ä—É–∂–∏—è
        </div>
        
        <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã -->
        <div id="mobileControls">
            <div id="joystick">
                <div id="joystickBase">
                    <div id="joystickKnob"></div>
                </div>
            </div>
            <div id="aimJoystick">
                <div id="aimJoystickBase">
                    <div id="aimJoystickKnob"></div>
                </div>
            </div>
            <button id="actionButton" class="mobileButton">üöó</button>
            <button id="weaponButton" class="mobileButton">‚öîÔ∏è</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
            if (tg.themeParams) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#222222');
            }
            
            // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ —Å–≤–∞–π–ø–µ –≤–Ω–∏–∑
            tg.disableVerticalSwipes();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
            tg.BackButton.onClick(() => {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã?')) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
                    savePlayerData();
                    tg.close();
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
            setTimeout(() => {
                tg.BackButton.show();
            }, 1000);
        }
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        window.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            const game = {
                camera: { x: 0, y: 0 },
                mapWidth: 3000,
                mapHeight: 3000,
                tileSize: 100
            };
            
            // –†–∞–π–æ–Ω—ã –≥–æ—Ä–æ–¥–∞
            const districts = {
                downtown: { name: '–¶–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞', x: 1000, y: 1000, width: 1000, height: 1000, color: '#444455' },
                industrial: { name: '–ü—Ä–æ–º–∑–æ–Ω–∞', x: 0, y: 0, width: 1000, height: 1000, color: '#554444' },
                residential: { name: '–°–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω', x: 2000, y: 0, width: 1000, height: 1000, color: '#445544' },
                docks: { name: '–î–æ–∫–∏', x: 0, y: 2000, width: 1000, height: 1000, color: '#445555' },
                chinatown: { name: '–ß–∞–π–Ω–∞—Ç–∞—É–Ω', x: 2000, y: 2000, width: 1000, height: 1000, color: '#555544' }
            };
            
            // –¢–∏–ø—ã –æ—Ä—É–∂–∏—è
            const weapons = {
                pistol: { name: '–ü–∏—Å—Ç–æ–ª–µ—Ç', damage: 25, fireRate: 10, bulletSpeed: 15, ammo: Infinity, color: '#ffff00' },
                uzi: { name: '–£–∑–∏', damage: 20, fireRate: 3, bulletSpeed: 18, ammo: 150, color: '#ff8800' },
                shotgun: { name: '–î—Ä–æ–±–æ–≤–∏–∫', damage: 15, fireRate: 30, bulletSpeed: 12, ammo: 50, color: '#ff0000', pellets: 5 },
                rifle: { name: '–í–∏–Ω—Ç–æ–≤–∫–∞', damage: 50, fireRate: 40, bulletSpeed: 25, ammo: 30, color: '#00ff00' }
            };
            
            // –ú—ã—à—å
            let mouseX = 0;
            let mouseY = 0;
            let mouseWorldX = 0;
            let mouseWorldY = 0;
            
            // –ò–≥—Ä–æ–∫
            const player = {
                x: 1500,
                y: 1500,
                width: 15,
                height: 15,
                speed: 3,
                angle: 0,
                health: 100,
                maxHealth: 100,
                armor: 0,
                maxArmor: 100,
                money: 0,
                wantedLevel: 0,
                inCar: null,
                isDead: false,
                respawnTimer: 0,
                invulnerableTime: 0,
                shootCooldown: 0,
                currentWeapon: 'pistol',
                weapons: {
                    pistol: { unlocked: true, ammo: Infinity },
                    uzi: { unlocked: false, ammo: 0 },
                    shotgun: { unlocked: false, ammo: 0 },
                    rifle: { unlocked: false, ammo: 0 }
                }
            };
            
            // –§—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ Telegram Cloud Storage
            function savePlayerData() {
                if (tg && tg.CloudStorage) {
                    const playerData = {
                        x: player.x,
                        y: player.y,
                        health: player.health,
                        armor: player.armor,
                        money: player.money,
                        wantedLevel: player.wantedLevel,
                        currentWeapon: player.currentWeapon,
                        weapons: player.weapons,
                        timestamp: Date.now()
                    };
                    
                    tg.CloudStorage.setItem('playerData', JSON.stringify(playerData), function(error) {
                        if (error) {
                            console.log('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                        } else {
                            console.log('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                        }
                    });
                }
            }
            
            function loadPlayerData() {
                if (tg && tg.CloudStorage) {
                    tg.CloudStorage.getItem('playerData', function(error, data) {
                        if (error) {
                            console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                            return;
                        }
                        
                        if (data) {
                            try {
                                const savedData = JSON.parse(data);
                                
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                                player.x = savedData.x || 1500;
                                player.y = savedData.y || 1500;
                                player.health = savedData.health || 100;
                                player.armor = savedData.armor || 0;
                                player.money = savedData.money || 0;
                                player.wantedLevel = savedData.wantedLevel || 0;
                                player.currentWeapon = savedData.currentWeapon || 'pistol';
                                
                                if (savedData.weapons) {
                                    Object.assign(player.weapons, savedData.weapons);
                                }
                                
                                console.log('–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω');
                            } catch (e) {
                                console.log('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', e);
                            }
                        } else {
                            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                        }
                    });
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ä–æ–Ω–∞ –∏–≥—Ä–æ–∫–æ–º
            function takeDamage(damage) {
                if (player.isDead || player.invulnerableTime > 0) return;
                
                // –°–Ω–∞—á–∞–ª–∞ —É—Ä–æ–Ω –ø–æ –±—Ä–æ–Ω–µ
                if (player.armor > 0) {
                    const armorDamage = Math.min(player.armor, damage);
                    player.armor -= armorDamage;
                    damage -= armorDamage;
                }
                
                // –£—Ä–æ–Ω –ø–æ –∑–¥–æ—Ä–æ–≤—å—é
                player.health = Math.max(0, player.health - damage);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Ä–æ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                sendToServer({
                    type: 'takeDamage',
                    damage: damage
                });
                
                // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –∫—Ä–æ–≤–∏
                createParticles(player.x, player.y, '#ff0000', 5);
                
                // –ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ —É—Ä–æ–Ω–∞
                player.invulnerableTime = 30;
            }
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            const keys = {};
            
            // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            let touchMovement = { x: 0, y: 0 };
            let touchAiming = { x: 0, y: 0 };
            let isMobile = false;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            function checkMobile() {
                isMobile = ('ontouchstart' in window) || 
                          (navigator.maxTouchPoints > 0) || 
                          (navigator.msMaxTouchPoints > 0);
            }
            checkMobile();
            
            // –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
            let socket = null;
            let playerId = null;
            let otherPlayers = new Map();
            let networkBullets = [];
            let networkCars = [];
            let isConnected = false;
            
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
            function connectToServer() {
                try {
                    const wsUrl = location.protocol === 'https:' ? 'wss://' : 'ws://';
                    socket = new WebSocket(wsUrl + location.host);
                    
                    socket.onopen = () => {
                        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                        isConnected = true;
                    };
                    
                    socket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        handleServerMessage(message);
                    };
                    
                    socket.onclose = () => {
                        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∑–∞–∫—Ä—ã—Ç–æ');
                        isConnected = false;
                        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(connectToServer, 3000);
                    };
                    
                    socket.onerror = (error) => {
                        console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
                    };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                    setTimeout(connectToServer, 3000);
                }
            }
            
            function handleServerMessage(message) {
                switch (message.type) {
                    case 'init':
                        playerId = message.playerId;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞ –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
                        player.x = message.player.x;
                        player.y = message.player.y;
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                        message.players.forEach(p => {
                            if (p.id !== playerId) {
                                otherPlayers.set(p.id, p);
                            }
                        });
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—à–∏–Ω—ã
                        networkCars = message.cars || [];
                        break;
                        
                    case 'playerJoined':
                        if (message.player.id !== playerId) {
                            otherPlayers.set(message.player.id, message.player);
                        }
                        break;
                        
                    case 'playerLeft':
                        otherPlayers.delete(message.playerId);
                        break;
                        
                    case 'playerMove':
                        if (message.playerId !== playerId) {
                            const otherPlayer = otherPlayers.get(message.playerId);
                            if (otherPlayer) {
                                otherPlayer.x = message.x;
                                otherPlayer.y = message.y;
                                otherPlayer.angle = message.angle;
                            }
                        }
                        break;
                        
                    case 'bulletFired':
                        networkBullets.push(message.bullet);
                        break;
                        
                    case 'bulletsUpdate':
                        networkBullets = message.bullets;
                        break;
                        
                    case 'bulletHit':
                        if (message.targetId === playerId) {
                            takeDamage(message.damage);
                        }
                        break;
                        
                    case 'playerRespawn':
                        if (message.playerId === playerId) {
                            player.x = message.x;
                            player.y = message.y;
                            player.health = message.health;
                        } else {
                            const otherPlayer = otherPlayers.get(message.playerId);
                            if (otherPlayer) {
                                otherPlayer.x = message.x;
                                otherPlayer.y = message.y;
                                otherPlayer.health = message.health;
                            }
                        }
                        break;
                        
                    case 'playerEnteredCar':
                        const otherPlayer = otherPlayers.get(message.playerId);
                        if (otherPlayer) {
                            otherPlayer.inCar = true;
                            otherPlayer.carId = message.carId;
                        }
                        break;
                        
                    case 'playerExitedCar':
                        const player2 = otherPlayers.get(message.playerId);
                        if (player2) {
                            player2.inCar = false;
                            player2.carId = null;
                        }
                        break;
                        
                    case 'carMove':
                        const car = networkCars.find(c => c.id === message.carId);
                        if (car) {
                            car.x = message.x;
                            car.y = message.y;
                            car.angle = message.angle;
                        }
                        break;
                }
            }
            
            function sendToServer(message) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(message));
                }
            }
            
            // –ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
            const cars = [];
            const policeCars = [];
            const policemen = [];
            const pedestrians = [];
            const gangMembers = [];
            const buildings = [];
            const bullets = [];
            const particles = [];
            const pickups = [];
            
            // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            const maxCars = 10;
            const maxPedestrians = 15;
            const maxGangMembers = 20;
            
            // –ë–∞–Ω–¥—ã
            const gangs = {
                yakuza: { 
                    name: '–Ø–∫—É–¥–∑–∞', 
                    color: '#ff0000', 
                    territory: 'chinatown',
                    enemyGangs: ['mafia', 'bikers']
                },
                mafia: { 
                    name: '–ú–∞—Ñ–∏—è', 
                    color: '#333333', 
                    territory: 'downtown',
                    enemyGangs: ['yakuza', 'street']
                },
                bikers: { 
                    name: '–ë–∞–π–∫–µ—Ä—ã', 
                    color: '#663300', 
                    territory: 'industrial',
                    enemyGangs: ['yakuza', 'mafia']
                },
                street: { 
                    name: '–£–ª–∏—á–Ω—ã–µ', 
                    color: '#006600', 
                    territory: 'residential',
                    enemyGangs: ['mafia', 'bikers']
                }
            };
            
            // –ö–ª–∞—Å—Å –ø–∏–∫–∞–ø–∞ (–æ—Ä—É–∂–∏–µ, –±—Ä–æ–Ω—è, –¥–µ–Ω—å–≥–∏)
            class Pickup {
                constructor(x, y, type, value = null) {
                    this.x = x;
                    this.y = y;
                    this.type = type; // 'weapon', 'armor', 'money', 'health'
                    this.value = value;
                    this.radius = 15;
                    this.bobOffset = 0;
                    this.collected = false;
                    
                    // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
                    this.colors = {
                        weapon: '#ff00ff',
                        armor: '#0000ff',
                        money: '#00ff00',
                        health: '#ff0000'
                    };
                }
                
                update() {
                    this.bobOffset += 0.1;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–æ–º
                    const dx = player.x - this.x;
                    const dy = player.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < this.radius + 10 && !player.inCar) {
                        this.collect();
                    }
                }
                
                collect() {
                    this.collected = true;
                    createParticles(this.x, this.y, this.colors[this.type], 10);
                    
                    switch(this.type) {
                        case 'weapon':
                            if (this.value && weapons[this.value]) {
                                player.weapons[this.value].unlocked = true;
                                player.weapons[this.value].ammo += weapons[this.value].ammo;
                                player.currentWeapon = this.value;
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ—Ä—É–∂–∏—è
                                savePlayerData();
                            }
                            break;
                        case 'armor':
                            player.armor = Math.min(player.maxArmor, player.armor + 50);
                            break;
                        case 'money':
                            player.money += this.value || 100;
                            break;
                        case 'health':
                            player.health = Math.min(player.maxHealth, player.health + 50);
                            break;
                    }
                }
                
                draw() {
                    const screenX = this.x - game.camera.x;
                    const screenY = this.y - game.camera.y + Math.sin(this.bobOffset) * 5;
                    
                    // –°–≤–µ—á–µ–Ω–∏–µ
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = this.colors[this.type];
                    
                    // –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä—É–≥
                    ctx.fillStyle = this.colors[this.type];
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –ò–∫–æ–Ω–∫–∞
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    switch(this.type) {
                        case 'weapon':
                            ctx.fillText('üî´', screenX, screenY);
                            break;
                        case 'armor':
                            ctx.fillText('üõ°Ô∏è', screenX, screenY);
                            break;
                        case 'money':
                            ctx.fillText('$', screenX, screenY);
                            break;
                        case 'health':
                            ctx.fillText('+', screenX, screenY);
                            break;
                    }
                    
                    ctx.shadowBlur = 0;
                }
            }
            
            // –ö–ª–∞—Å—Å —á–µ–ª–æ–≤–µ–∫–∞ (–±–∞–∑–æ–≤—ã–π –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π)
            class Person {
                constructor(x, y, color = '#ff9900') {
                    this.x = x;
                    this.y = y;
                    this.width = 10;
                    this.height = 10;
                    this.radius = 8;
                    this.angle = 0;
                    this.color = color;
                    this.health = 100;
                    this.maxHealth = 100;
                    this.armor = 0;
                    this.isDead = false;
                }
                
                drawPerson(isPlayer = false) {
                    const screenX = this.x - game.camera.x;
                    const screenY = this.y - game.camera.y;
                    
                    ctx.save();
                    ctx.translate(screenX, screenY);
                    ctx.rotate(this.angle);
                    
                    // –¢–µ–Ω—å
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    ctx.beginPath();
                    ctx.ellipse(2, 2, this.radius * 0.8, this.radius * 0.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –¢–µ–ª–æ
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –ë—Ä–æ–Ω—è
                    if (this.armor > 0) {
                        ctx.strokeStyle = '#0066ff';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(0, 0, this.radius + 2, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    
                    // –ì–æ–ª–æ–≤–∞
                    ctx.fillStyle = '#ffcc99';
                    ctx.beginPath();
                    ctx.arc(0, -this.radius * 0.7, this.radius * 0.5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –†—É–∫–∏ —Å –æ—Ä—É–∂–∏–µ–º
                    if (isPlayer || this instanceof Policeman || this instanceof GangMember) {
                        ctx.strokeStyle = this.color;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(this.radius * 1.5, 0);
                        ctx.stroke();
                        
                        // –û—Ä—É–∂–∏–µ
                        ctx.fillStyle = '#333';
                        ctx.fillRect(this.radius * 1.3, -2, 8, 4);
                    }
                    
                    ctx.restore();
                    
                    // –ü–æ–ª–æ—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è
                    if (this.health < this.maxHealth && this.health > 0) {
                        ctx.fillStyle = '#ff0000';
                        ctx.fillRect(screenX - 15, screenY - 20, 30, 3);
                        ctx.fillStyle = '#00ff00';
                        ctx.fillRect(screenX - 15, screenY - 20, 30 * (this.health / this.maxHealth), 3);
                    }
                }
                
                takeDamage(damage) {
                    if (this.isDead) return;
                    
                    // –°–Ω–∞—á–∞–ª–∞ —É—Ä–æ–Ω –ø–æ –±—Ä–æ–Ω–µ
                    if (this.armor > 0) {
                        const armorDamage = Math.min(this.armor, damage * 0.7);
                        this.armor -= armorDamage;
                        damage -= armorDamage;
                    }
                    
                    this.health -= damage;
                    createParticles(this.x, this.y, '#ff0000', 5);
                    
                    if (this.health <= 0) {
                        this.health = 0;
                        this.isDead = true;
                        createParticles(this.x, this.y, this.color, 15);
                        
                        // –®–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                        if (Math.random() < 0.3) {
                            const types = ['money', 'health', 'armor'];
                            const type = types[Math.floor(Math.random() * types.length)];
                            pickups.push(new Pickup(this.x, this.y, type, type === 'money' ? 50 : null));
                        }
                    }
                }
            }
            
            // –ö–ª–∞—Å—Å —á–ª–µ–Ω–∞ –±–∞–Ω–¥—ã
            class GangMember extends Person {
                constructor(x, y, gang) {
                    super(x, y, gangs[gang].color);
                    this.gang = gang;
                    this.speed = 1.5;
                    this.shootCooldown = 0;
                    this.targetDistance = 250;
                    this.health = 150;
                    this.maxHealth = 150;
                    this.armor = 25;
                    this.weapon = Math.random() < 0.5 ? 'uzi' : 'pistol';
                    this.aggressive = true;
                    this.patrolTarget = { x: x, y: y };
                    this.patrolRadius = 200;
                    this.wasAttacked = false;
                    this.attackedBy = null;
                    this.alertTimer = 0;
                }
                
                update() {
                    if (this.isDead) return;
                    
                    this.shootCooldown--;
                    
                    // –£–º–µ–Ω—å—à–∞–µ–º —Ç–∞–π–º–µ—Ä —Ç—Ä–µ–≤–æ–≥–∏
                    if (this.alertTimer > 0) {
                        this.alertTimer--;
                        if (this.alertTimer === 0) {
                            this.wasAttacked = false;
                            this.attackedBy = null;
                        }
                    }
                    
                    let target = null;
                    let targetDistance = Infinity;
                    
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ê—Ç–∞–∫–æ–≤–∞—Ç—å —Ç–æ–≥–æ, –∫—Ç–æ —Å—Ç—Ä–µ–ª—è–ª –≤ –Ω–∞—Å
                    if (this.wasAttacked && this.attackedBy === 'player' && !player.isDead) {
                        const dx = player.x - this.x;
                        const dy = player.y - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < this.targetDistance * 1.5) { // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –¥–ª—è –º–µ—Å—Ç–∏
                            target = player;
                            targetDistance = dist;
                        }
                    }
                    
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò—â–µ–º –≤—Ä–∞–≥–æ–≤ (–∏–≥—Ä–æ–∫ —Å –≤—ã—Å–æ–∫–∏–º —Ä–æ–∑—ã—Å–∫–æ–º –∏–ª–∏ –≤—Ä–∞–∂–¥–µ–±–Ω—ã–µ –±–∞–Ω–¥—ã)
                    if (!target) {
                        if (player.wantedLevel >= 2 && !player.isDead) {
                            const dx = player.x - this.x;
                            const dy = player.y - this.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < this.targetDistance) {
                                target = player;
                                targetDistance = dist;
                            }
                        }
                        
                        // –ò—â–µ–º —á–ª–µ–Ω–æ–≤ –≤—Ä–∞–∂–¥–µ–±–Ω—ã—Ö –±–∞–Ω–¥
                        gangMembers.forEach(member => {
                            if (member !== this && !member.isDead && 
                                gangs[this.gang].enemyGangs.includes(member.gang)) {
                                const dx = member.x - this.x;
                                const dy = member.y - this.y;
                                const dist = Math.sqrt(dx * dx + dy * dy);
                                if (dist < this.targetDistance && dist < targetDistance) {
                                    target = member;
                                    targetDistance = dist;
                                }
                            }
                        });
                    }
                    
                    if (target) {
                        // –ê—Ç–∞–∫–∞ —Ü–µ–ª–∏
                        const dx = target.x - this.x;
                        const dy = target.y - this.y;
                        this.angle = Math.atan2(dy, dx);
                        
                        if (targetDistance > 50) {
                            this.x += Math.cos(this.angle) * this.speed;
                            this.y += Math.sin(this.angle) * this.speed;
                        }
                        
                        // –°—Ç—Ä–µ–ª—å–±–∞
                        if (targetDistance < this.targetDistance && this.shootCooldown <= 0) {
                            const weapon = weapons[this.weapon];
                            
                            if (weapon.pellets) {
                                // –î—Ä–æ–±–æ–≤–∏–∫
                                for (let i = 0; i < weapon.pellets; i++) {
                                    const spread = (Math.random() - 0.5) * 0.3;
                                    bullets.push(new Bullet(
                                        this.x + Math.cos(this.angle) * 15,
                                        this.y + Math.sin(this.angle) * 15,
                                        this.angle + spread,
                                        false,
                                        weapon.damage,
                                        weapon.bulletSpeed,
                                        weapon.color,
                                        'gang'
                                    ));
                                }
                            } else {
                                bullets.push(new Bullet(
                                    this.x + Math.cos(this.angle) * 15,
                                    this.y + Math.sin(this.angle) * 15,
                                    this.angle,
                                    false,
                                    weapon.damage,
                                    weapon.bulletSpeed,
                                    weapon.color,
                                    'gang'
                                ));
                            }
                            this.shootCooldown = weapon.fireRate;
                        }
                    } else {
                        // –ü–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
                        const dx = this.patrolTarget.x - this.x;
                        const dy = this.patrolTarget.y - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < 20 || Math.random() < 0.01) {
                            // –ù–æ–≤–∞—è —Ç–æ—á–∫–∞ –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                            const angle = Math.random() * Math.PI * 2;
                            const radius = Math.random() * this.patrolRadius;
                            this.patrolTarget = {
                                x: this.x + Math.cos(angle) * radius,
                                y: this.y + Math.sin(angle) * radius
                            };
                        }
                        
                        this.angle = Math.atan2(dy, dx);
                        this.x += Math.cos(this.angle) * this.speed * 0.5;
                        this.y += Math.sin(this.angle) * this.speed * 0.5;
                    }
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã
                    this.x = Math.max(10, Math.min(game.mapWidth - 10, this.x));
                    this.y = Math.max(10, Math.min(game.mapHeight - 10, this.y));
                }
                
                takeDamage(damage, source = 'unknown') {
                    super.takeDamage(damage);
                    
                    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫—Ç–æ –≤ –Ω–∞—Å —Å—Ç—Ä–µ–ª—è–ª
                    if (!this.isDead && source === 'player') {
                        this.wasAttacked = true;
                        this.attackedBy = 'player';
                        this.alertTimer = 300; // 5 —Å–µ–∫—É–Ω–¥ –ø–æ–º–Ω–∏—Ç –æ–±–∏–¥—á–∏–∫–∞
                        
                        // –û–ø–æ–≤–µ—â–∞–µ–º –±–ª–∏–∂–∞–π—à–∏—Ö —á–ª–µ–Ω–æ–≤ –±–∞–Ω–¥—ã
                        gangMembers.forEach(member => {
                            if (member !== this && member.gang === this.gang && !member.isDead) {
                                const dx = member.x - this.x;
                                const dy = member.y - this.y;
                                const dist = Math.sqrt(dx * dx + dy * dy);
                                
                                if (dist < 200) { // –†–∞–¥–∏—É—Å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
                                    member.wasAttacked = true;
                                    member.attackedBy = 'player';
                                    member.alertTimer = 200;
                                }
                            }
                        });
                    }
                }
                
                draw() {
                    if (!this.isDead) {
                        this.drawPerson(false);
                        
                        // –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–¥—ã –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π
                        const screenX = this.x - game.camera.x;
                        const screenY = this.y - game.camera.y;
                        
                        ctx.fillStyle = this.color;
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(gangs[this.gang].name, screenX, screenY - 25);
                        
                        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≥—Ä–µ—Å—Å–∏–∏
                        if (this.wasAttacked) {
                            ctx.fillStyle = '#ff0000';
                            ctx.fillText('!', screenX + 15, screenY - 15);
                        }
                    }
                }
            }
            
            // –ö–ª–∞—Å—Å –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ
            class Policeman extends Person {
                constructor(x, y) {
                    super(x, y, '#000033');
                    this.speed = 2;
                    this.shootCooldown = 0;
                    this.targetDistance = 200;
                    this.isFromCar = false;
                }
                
                update() {
                    if (this.isDead) return;
                    
                    this.shootCooldown--;
                    
                    if (player.wantedLevel > 0 && !player.isDead) {
                        const target = player.inCar || player;
                        const dx = target.x - this.x;
                        const dy = target.y - this.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 400) {
                            // –ü—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
                            this.angle = Math.atan2(dy, dx);
                            
                            if (distance > 50) {
                                this.x += Math.cos(this.angle) * this.speed;
                                this.y += Math.sin(this.angle) * this.speed;
                            }
                            
                            // –°—Ç—Ä–µ–ª—å–±–∞
                            if (distance < this.targetDistance && this.shootCooldown <= 0) {
                                bullets.push(new Bullet(
                                    this.x + Math.cos(this.angle) * 15,
                                    this.y + Math.sin(this.angle) * 15,
                                    this.angle,
                                    false,
                                    10,
                                    15,
                                    '#ff6600',
                                    'police'
                                ));
                                this.shootCooldown = 30;
                            }
                        }
                    }
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã
                    this.x = Math.max(10, Math.min(game.mapWidth - 10, this.x));
                    this.y = Math.max(10, Math.min(game.mapHeight - 10, this.y));
                }
                
                draw() {
                    if (!this.isDead) {
                        this.drawPerson(false);
                    }
                }
            }
            
            // –ö–ª–∞—Å—Å –º–∞—à–∏–Ω—ã
            class Car {
                constructor(x, y, color) {
                    this.x = x;
                    this.y = y;
                    this.width = 40;
                    this.height = 20;
                    this.color = color;
                    this.angle = Math.random() * Math.PI * 2;
                    this.speed = 0;
                    this.maxSpeed = 4;
                    this.acceleration = 0.1;
                    this.friction = 0.95;
                    this.turnSpeed = 0.05;
                    this.health = 100;
                    this.isPolice = false;
                    this.policeman = null;
                }
                
                update() {
                    if (this === player.inCar) return;
                    
                    // –ü—Ä–æ—Å—Ç–æ–µ –ò–ò –¥–≤–∏–∂–µ–Ω–∏–µ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –º–∞—à–∏–Ω
                    if (!this.isPolice) {
                        if (Math.random() < 0.02) {
                            this.angle += (Math.random() - 0.5) * 0.3;
                        }
                        
                        if (Math.random() < 0.8) {
                            this.speed = Math.min(this.speed + this.acceleration, this.maxSpeed * 0.7);
                        }
                    }
                    
                    // –î–≤–∏–∂–µ–Ω–∏–µ
                    this.x += Math.cos(this.angle) * this.speed;
                    this.y += Math.sin(this.angle) * this.speed;
                    
                    // –¢—Ä–µ–Ω–∏–µ
                    this.speed *= this.friction;
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
                    if (this.x < 50 || this.x > game.mapWidth - 50) {
                        this.angle = Math.PI - this.angle;
                        this.x = Math.max(50, Math.min(game.mapWidth - 50, this.x));
                        this.speed *= 0.5;
                    }
                    if (this.y < 50 || this.y > game.mapHeight - 50) {
                        this.angle = -this.angle;
                        this.y = Math.max(50, Math.min(game.mapHeight - 50, this.y));
                        this.speed *= 0.5;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å–æ –∑–¥–∞–Ω–∏—è–º–∏
                    buildings.forEach(building => {
                        if (this.checkCollision(building)) {
                            this.angle += Math.PI;
                            this.speed *= -0.5;
                            this.x += Math.cos(this.angle) * 5;
                            this.y += Math.sin(this.angle) * 5;
                        }
                    });
                }
                
                checkCollision(obj) {
                    return this.x - this.width/2 < obj.x + obj.width &&
                           this.x + this.width/2 > obj.x &&
                           this.y - this.height/2 < obj.y + obj.height &&
                           this.y + this.height/2 > obj.y;
                }
                
                draw() {
                    ctx.save();
                    ctx.translate(this.x - game.camera.x, this.y - game.camera.y);
                    ctx.rotate(this.angle);
                    
                    // –¢–µ–Ω—å
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    ctx.fillRect(-this.width/2 + 3, -this.height/2 + 3, this.width, this.height);
                    
                    // –¢–µ–ª–æ –º–∞—à–∏–Ω—ã
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                    
                    // –û–∫–Ω–∞
                    ctx.fillStyle = 'rgba(100,100,100,0.8)';
                    ctx.fillRect(-this.width/3, -this.height/3, this.width/1.5, this.height/1.5);
                    
                    // –§–∞—Ä—ã
                    ctx.fillStyle = '#ffffaa';
                    ctx.fillRect(this.width/2 - 5, -this.height/3, 5, 5);
                    ctx.fillRect(this.width/2 - 5, this.height/3 - 5, 5, 5);
                    
                    // –ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–π –≤–Ω—É—Ç—Ä–∏
                    if (this.isPolice && this.policeman) {
                        ctx.fillStyle = '#000033';
                        ctx.beginPath();
                        ctx.arc(0, 0, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.restore();
                }
            }
            
            // –ö–ª–∞—Å—Å –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –º–∞—à–∏–Ω—ã
            class PoliceCar extends Car {
                constructor(x, y) {
                    super(x, y, '#1a1a1a');
                    this.isPolice = true;
                    this.maxSpeed = 5;
                    this.sirenPhase = 0;
                    this.policeman = new Policeman(x, y);
                    this.hasExited = false;
                }
                
                update() {
                    this.sirenPhase += 0.1;
                    
                    if (player.wantedLevel > 0 && !player.isDead) {
                        const target = player.inCar || player;
                        const dx = target.x - this.x;
                        const dy = target.y - this.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 500) {
                            // –ü—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
                            const targetAngle = Math.atan2(dy, dx);
                            let angleDiff = targetAngle - this.angle;
                            
                            while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                            while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                            
                            this.angle += angleDiff * 0.05;
                            this.speed = Math.min(this.speed + this.acceleration * 1.5, this.maxSpeed);
                            
                            // –í—ã—Ö–æ–¥ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ –∏–∑ –º–∞—à–∏–Ω—ã –ø—Ä–∏ –±–ª–∏–∑–∫–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏
                            if (distance < 150 && !this.hasExited && this.speed < 1) {
                                this.exitPoliceman();
                            }
                        } else {
                            super.update();
                            return;
                        }
                    } else {
                        super.update();
                        return;
                    }
                    
                    // –î–≤–∏–∂–µ–Ω–∏–µ
                    this.x += Math.cos(this.angle) * this.speed;
                    this.y += Math.sin(this.angle) * this.speed;
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã
                    this.x = Math.max(50, Math.min(game.mapWidth - 50, this.x));
                    this.y = Math.max(50, Math.min(game.mapHeight - 50, this.y));
                    
                    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
                    buildings.forEach(building => {
                        if (this.checkCollision(building)) {
                            this.angle += Math.PI * 0.7;
                            this.speed *= 0.3;
                            this.x += Math.cos(this.angle) * 10;
                            this.y += Math.sin(this.angle) * 10;
                        }
                    });
                }
                
                exitPoliceman() {
                    if (this.policeman && !this.hasExited) {
                        this.policeman.x = this.x + Math.cos(this.angle - Math.PI/2) * 30;
                        this.policeman.y = this.y + Math.sin(this.angle - Math.PI/2) * 30;
                        this.policeman.isFromCar = true;
                        policemen.push(this.policeman);
                        this.policeman = null;
                        this.hasExited = true;
                    }
                }
                
                draw() {
                    super.draw();
                    
                    // –ú–∏–≥–∞–ª–∫–∏
                    if (player.wantedLevel > 0) {
                        ctx.save();
                        ctx.translate(this.x - game.camera.x, this.y - game.camera.y);
                        ctx.rotate(this.angle);
                        
                        const lightOn = Math.sin(this.sirenPhase) > 0;
                        if (lightOn) {
                            ctx.fillStyle = '#ff0000';
                            ctx.fillRect(-this.width/2 + 5, -this.height/2 - 5, 8, 5);
                            ctx.fillStyle = '#0000ff';
                            ctx.fillRect(this.width/2 - 13, -this.height/2 - 5, 8, 5);
                        }
                        
                        ctx.restore();
                    }
                }
            }
            
            // –ö–ª–∞—Å—Å –ø–µ—à–µ—Ö–æ–¥–∞
            class Pedestrian extends Person {
                constructor(x, y) {
                    super(x, y, `hsl(${Math.random() * 360}, 50%, 50%)`);
                    this.speed = 0.5;
                    this.normalSpeed = 0.5;
                    this.runSpeed = 2;
                    this.angle = Math.random() * Math.PI * 2;
                    this.panic = false;
                }
                
                update() {
                    if (this.isDead) return;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–∏–∑–æ—Å—Ç–∏ –º–∞—à–∏–Ω
                    this.panic = false;
                    [...cars, ...policeCars].forEach(car => {
                        const dx = car.x - this.x;
                        const dy = car.y - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < 60 && car.speed > 1) {
                            this.panic = true;
                            this.angle = Math.atan2(-dy, -dx);
                        }
                    });
                    
                    // –£–±–µ–≥–∞–Ω–∏–µ –æ—Ç —Å—Ç—Ä–µ–ª—å–±—ã
                    bullets.forEach(bullet => {
                        const dx = bullet.x - this.x;
                        const dy = bullet.y - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < 100) {
                            this.panic = true;
                            this.angle = Math.atan2(-dy, -dx);
                        }
                    });
                    
                    // –£–±–µ–≥–∞–Ω–∏–µ –æ—Ç —á–ª–µ–Ω–æ–≤ –±–∞–Ω–¥
                    gangMembers.forEach(gang => {
                        if (!gang.isDead) {
                            const dx = gang.x - this.x;
                            const dy = gang.y - this.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            
                            if (dist < 80) {
                                this.panic = true;
                                this.angle = Math.atan2(-dy, -dx);
                            }
                        }
                    });
                    
                    // –î–≤–∏–∂–µ–Ω–∏–µ
                    if (this.panic) {
                        this.speed = this.runSpeed;
                    } else {
                        this.speed = this.normalSpeed;
                        if (Math.random() < 0.02) {
                            this.angle = Math.random() * Math.PI * 2;
                        }
                    }
                    
                    this.x += Math.cos(this.angle) * this.speed;
                    this.y += Math.sin(this.angle) * this.speed;
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã
                    this.x = Math.max(10, Math.min(game.mapWidth - 10, this.x));
                    this.y = Math.max(10, Math.min(game.mapHeight - 10, this.y));
                    
                    // –ò–∑–±–µ–≥–∞–Ω–∏–µ –∑–¥–∞–Ω–∏–π
                    buildings.forEach(building => {
                        if (this.x > building.x - 10 && this.x < building.x + building.width + 10 &&
                            this.y > building.y - 10 && this.y < building.y + building.height + 10) {
                            this.angle += Math.PI;
                            this.x += Math.cos(this.angle) * 5;
                            this.y += Math.sin(this.angle) * 5;
                        }
                    });
                }
                
                draw() {
                    if (!this.isDead) {
                        this.drawPerson(false);
                    }
                }
            }
            
            // –ö–ª–∞—Å—Å –ø—É–ª–∏
            class Bullet {
                constructor(x, y, angle, isPlayerBullet = true, damage = 25, speed = 15, color = '#ffff00', source = 'player') {
                    this.x = x;
                    this.y = y;
                    this.angle = angle;
                    this.speed = speed;
                    this.lifetime = 60;
                    this.damage = damage;
                    this.radius = 3;
                    this.isPlayerBullet = isPlayerBullet;
                    this.dx = Math.cos(angle) * this.speed;
                    this.dy = Math.sin(angle) * this.speed;
                    this.color = color;
                    this.source = source; // 'player', 'police', 'gang'
                }
                
                update() {
                    this.x += this.dx;
                    this.y += this.dy;
                    this.lifetime--;
                    
                    if (this.source === 'player') {
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –ø–µ—à–µ—Ö–æ–¥–æ–≤
                        pedestrians.forEach(ped => {
                            if (!ped.isDead && this.checkHit(ped)) {
                                ped.takeDamage(this.damage);
                                if (ped.isDead) {
                                    player.wantedLevel = Math.min(player.wantedLevel + 1, 5);
                                    player.money += 10;
                                    
                                    if (player.wantedLevel >= 2 && policeCars.length < 5) {
                                        spawnPoliceCar();
                                    }
                                }
                                this.lifetime = 0;
                            }
                        });
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏—Ö
                        policemen.forEach(cop => {
                            if (!cop.isDead && this.checkHit(cop)) {
                                cop.takeDamage(this.damage);
                                if (cop.isDead) {
                                    player.wantedLevel = Math.min(player.wantedLevel + 2, 5);
                                    player.money += 50;
                                }
                                this.lifetime = 0;
                            }
                        });
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ —á–ª–µ–Ω–æ–≤ –±–∞–Ω–¥
                        gangMembers.forEach(gang => {
                            if (!gang.isDead && this.checkHit(gang)) {
                                gang.takeDamage(this.damage, 'player');
                                if (gang.isDead) {
                                    player.wantedLevel = Math.min(player.wantedLevel + 1, 5);
                                    player.money += 100;
                                    
                                    // –®–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è –æ—Ä—É–∂–∏—è
                                    if (Math.random() < 0.4) {
                                        pickups.push(new Pickup(gang.x, gang.y, 'weapon', gang.weapon));
                                    }
                                }
                                this.lifetime = 0;
                            }
                        });
                    } else if (this.source === 'police') {
                        // –ü—É–ª–∏ –ø–æ–ª–∏—Ü–∏–∏
                        if (!player.isDead && player.invulnerableTime <= 0 && this.checkHit(player)) {
                            player.armor > 0 ? player.armor -= this.damage : player.health -= this.damage;
                            player.invulnerableTime = 20;
                            createParticles(player.x, player.y, '#ff0000', 10);
                            this.lifetime = 0;
                        }
                    } else if (this.source === 'gang') {
                        // –ü—É–ª–∏ –±–∞–Ω–¥
                        if (!player.isDead && player.invulnerableTime <= 0 && this.checkHit(player)) {
                            player.armor > 0 ? player.armor -= this.damage : player.health -= this.damage;
                            player.invulnerableTime = 20;
                            createParticles(player.x, player.y, '#ff0000', 10);
                            this.lifetime = 0;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –¥—Ä—É–≥–∏—Ö —á–ª–µ–Ω–æ–≤ –±–∞–Ω–¥
                        gangMembers.forEach(gang => {
                            if (!gang.isDead && this.checkHit(gang)) {
                                gang.takeDamage(this.damage);
                                this.lifetime = 0;
                            }
                        });
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –ø–æ–ª–∏—Ü–∏—é
                        policemen.forEach(cop => {
                            if (!cop.isDead && this.checkHit(cop)) {
                                cop.takeDamage(this.damage);
                                this.lifetime = 0;
                            }
                        });
                    }
                }
                
                checkHit(target) {
                    const dx = target.x - this.x;
                    const dy = target.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    return dist < this.radius + (target.radius || 10);
                }
                
                draw() {
                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x - game.camera.x, this.y - game.camera.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
                
                isOffScreen() {
                    return this.x < 0 || this.x > game.mapWidth || 
                           this.y < 0 || this.y > game.mapHeight ||
                           this.lifetime <= 0;
                }
            }
            
            // –ö–ª–∞—Å—Å —á–∞—Å—Ç–∏—Ü—ã
            class Particle {
                constructor(x, y, color) {
                    this.x = x;
                    this.y = y;
                    this.dx = (Math.random() - 0.5) * 8;
                    this.dy = (Math.random() - 0.5) * 8;
                    this.radius = Math.random() * 3 + 1;
                    this.color = color;
                    this.life = 1;
                    this.decay = 0.02;
                }
                
                update() {
                    this.x += this.dx;
                    this.y += this.dy;
                    this.dx *= 0.98;
                    this.dy *= 0.98;
                    this.life -= this.decay;
                }
                
                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.life;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x - game.camera.x, this.y - game.camera.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            function createParticles(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    particles.push(new Particle(x, y, color));
                }
            }
            
            function spawnPoliceCar() {
                const angle = Math.random() * Math.PI * 2;
                const distance = 600;
                policeCars.push(new PoliceCar(
                    player.x + Math.cos(angle) * distance,
                    player.y + Math.sin(angle) * distance
                ));
            }
            
            function getCurrentDistrict() {
                for (let key in districts) {
                    const district = districts[key];
                    if (player.x >= district.x && player.x < district.x + district.width &&
                        player.y >= district.y && player.y < district.y + district.height) {
                        return district.name;
                    }
                }
                return '–û–∫—Ä–∞–∏–Ω–∞';
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏—Ä–∞
            function init() {
                // –°–æ–∑–¥–∞–Ω–∏–µ –∑–¥–∞–Ω–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–π–æ–Ω–∞—Ö
                for (let districtKey in districts) {
                    const district = districts[districtKey];
                    const buildingCount = 15;
                    
                    for (let i = 0; i < buildingCount; i++) {
                        let building;
                        let attempts = 0;
                        
                        do {
                            building = {
                                x: district.x + Math.random() * (district.width - 150) + 50,
                                y: district.y + Math.random() * (district.height - 150) + 50,
                                width: 60 + Math.random() * 100,
                                height: 60 + Math.random() * 100,
                                color: `hsl(${200 + Math.random() * 40}, 20%, ${25 + Math.random() * 15}%)`,
                                district: districtKey
                            };
                            attempts++;
                        } while (checkBuildingOverlap(building) && attempts < 50);
                        
                        if (attempts < 50) {
                            buildings.push(building);
                        }
                    }
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—à–∏–Ω
                for (let i = 0; i < maxCars; i++) {
                    const colors = ['#ff3333', '#33ff33', '#3333ff', '#ffff33', '#ff33ff', '#33ffff', '#ff6633', '#6633ff'];
                    const car = new Car(
                        Math.random() * game.mapWidth,
                        Math.random() * game.mapHeight,
                        colors[Math.floor(Math.random() * colors.length)]
                    );
                    cars.push(car);
                }
                
                // –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–µ –º–∞—à–∏–Ω—ã
                for (let i = 0; i < 2; i++) {
                    policeCars.push(new PoliceCar(
                        Math.random() * game.mapWidth,
                        Math.random() * game.mapHeight
                    ));
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—à–µ—Ö–æ–¥–æ–≤
                for (let i = 0; i < maxPedestrians; i++) {
                    pedestrians.push(new Pedestrian(
                        Math.random() * game.mapWidth,
                        Math.random() * game.mapHeight
                    ));
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —á–ª–µ–Ω–æ–≤ –±–∞–Ω–¥ –≤ –∏—Ö —Ä–∞–π–æ–Ω–∞—Ö
                for (let gangKey in gangs) {
                    const gang = gangs[gangKey];
                    const district = districts[gang.territory];
                    
                    for (let i = 0; i < 5; i++) {
                        gangMembers.push(new GangMember(
                            district.x + Math.random() * district.width,
                            district.y + Math.random() * district.height,
                            gangKey
                        ));
                    }
                }
                
                // –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–∏–∫–∞–ø—ã
                for (let i = 0; i < 10; i++) {
                    const types = ['weapon', 'armor', 'money', 'health'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    let value = null;
                    
                    if (type === 'weapon') {
                        const weaponTypes = ['uzi', 'shotgun', 'rifle'];
                        value = weaponTypes[Math.floor(Math.random() * weaponTypes.length)];
                    } else if (type === 'money') {
                        value = 100 + Math.floor(Math.random() * 4) * 50;
                    }
                    
                    pickups.push(new Pickup(
                        Math.random() * game.mapWidth,
                        Math.random() * game.mapHeight,
                        type,
                        value
                    ));
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –∑–¥–∞–Ω–∏–π
            function checkBuildingOverlap(newBuilding) {
                for (let building of buildings) {
                    if (newBuilding.x < building.x + building.width + 20 &&
                        newBuilding.x + newBuilding.width + 20 > building.x &&
                        newBuilding.y < building.y + building.height + 20 &&
                        newBuilding.y + newBuilding.height + 20 > building.y) {
                        return true;
                    }
                }
                return false;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
            function update() {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—Ä—Ç–∏
                if (player.health <= 0 && !player.isDead) {
                    player.isDead = true;
                    player.respawnTimer = 180;
                    player.inCar = null;
                    if (player.money > 0) {
                        player.money = Math.floor(player.money * 0.5);
                    }
                }
                
                // –†–µ—Å–ø–∞–≤–Ω
                if (player.isDead) {
                    player.respawnTimer--;
                    if (player.respawnTimer <= 0) {
                        player.isDead = false;
                        player.health = player.maxHealth;
                        player.armor = 0;
                        player.x = 1500;
                        player.y = 1500;
                        player.wantedLevel = 0;
                        player.invulnerableTime = 120;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ —Ä–µ—Å–ø–∞—É–Ω–∞
                        savePlayerData();
                    }
                    return;
                }
                
                // –ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ —Ä–µ—Å–ø–∞–≤–Ω–∞
                if (player.invulnerableTime > 0) {
                    player.invulnerableTime--;
                }
                
                // –ö—É–ª–¥–∞—É–Ω —Å—Ç—Ä–µ–ª—å–±—ã
                if (player.shootCooldown > 0) {
                    player.shootCooldown--;
                }
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–º
                if (player.inCar) {
                    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω–æ–π
                    if (keys['w'] || keys['W'] || keys['KeyW'] || keys['—Ü'] || keys['–¶'] || touchMovement.y < -0.3) {
                        player.inCar.speed = Math.min(player.inCar.speed + 0.2, player.inCar.maxSpeed);
                    }
                    if (keys['s'] || keys['S'] || keys['KeyS'] || keys['—ã'] || keys['–´'] || touchMovement.y > 0.3) {
                        player.inCar.speed = Math.max(player.inCar.speed - 0.15, -player.inCar.maxSpeed/2);
                    }
                    if (keys['a'] || keys['A'] || keys['KeyA'] || keys['—Ñ'] || keys['–§'] || touchMovement.x < -0.3) {
                        if (Math.abs(player.inCar.speed) > 0.5) {
                            player.inCar.angle -= player.inCar.turnSpeed * (player.inCar.speed / player.inCar.maxSpeed);
                        }
                    }
                    if (keys['d'] || keys['D'] || keys['KeyD'] || keys['–≤'] || keys['–í'] || touchMovement.x > 0.3) {
                        if (Math.abs(player.inCar.speed) > 0.5) {
                            player.inCar.angle += player.inCar.turnSpeed * (player.inCar.speed / player.inCar.maxSpeed);
                        }
                    }
                    
                    // –§–∏–∑–∏–∫–∞ –º–∞—à–∏–Ω—ã
                    player.inCar.x += Math.cos(player.inCar.angle) * player.inCar.speed;
                    player.inCar.y += Math.sin(player.inCar.angle) * player.inCar.speed;
                    player.inCar.speed *= player.inCar.friction;
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã
                    player.inCar.x = Math.max(30, Math.min(game.mapWidth - 30, player.inCar.x));
                    player.inCar.y = Math.max(30, Math.min(game.mapHeight - 30, player.inCar.y));
                    
                    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
                    buildings.forEach(building => {
                        if (player.inCar.checkCollision(building)) {
                            player.inCar.speed *= -0.8;
                            player.inCar.x += Math.cos(player.inCar.angle) * player.inCar.speed * 2;
                            player.inCar.y += Math.sin(player.inCar.angle) * player.inCar.speed * 2;
                        }
                    });
                    
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞ —Å –º–∞—à–∏–Ω–æ–π
                    player.x = player.inCar.x;
                    player.y = player.inCar.y;
                    player.angle = player.inCar.angle;
                } else {
                    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—à–∫–æ–º
                    let dx = 0, dy = 0;
                    
                    if (keys['w'] || keys['W'] || keys['KeyW'] || keys['—Ü'] || keys['–¶']) dy = -player.speed;
                    if (keys['s'] || keys['S'] || keys['KeyS'] || keys['—ã'] || keys['–´']) dy = player.speed;
                    if (keys['a'] || keys['A'] || keys['KeyA'] || keys['—Ñ'] || keys['–§']) dx = -player.speed;
                    if (keys['d'] || keys['D'] || keys['KeyD'] || keys['–≤'] || keys['–í']) dx = player.speed;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞
                    if (touchMovement.x !== 0 || touchMovement.y !== 0) {
                        dx = touchMovement.x * player.speed;
                        dy = touchMovement.y * player.speed;
                    }
                    
                    if (dx !== 0 || dy !== 0) {
                        player.x += dx;
                        player.y += dy;
                    }
                    
                    // –ü–æ–≤–æ—Ä–æ—Ç –∫ –º—ã—à–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞)
                    if (!isMobile) {
                        player.angle = Math.atan2(mouseWorldY - player.y, mouseWorldX - player.x);
                    } else if (touchAiming.x !== 0 || touchAiming.y !== 0) {
                        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∂–æ–π—Å—Ç–∏–∫ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞
                        player.angle = Math.atan2(touchAiming.y, touchAiming.x);
                    } else if (touchMovement.x !== 0 || touchMovement.y !== 0) {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –≤–≤–æ–¥–∞ –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ
                        player.angle = Math.atan2(touchMovement.y, touchMovement.x);
                    }
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã
                    player.x = Math.max(10, Math.min(game.mapWidth - 10, player.x));
                    player.y = Math.max(10, Math.min(game.mapHeight - 10, player.y));
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    sendToServer({
                        type: 'move',
                        x: player.x,
                        y: player.y,
                        angle: player.angle
                    });
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π –∏–≥—Ä–æ–∫–∞ —Å –º–∞—à–∏–Ω–∞–º–∏ (–Ω–∞–µ–∑–¥)
                if (!player.inCar && player.invulnerableTime <= 0) {
                    [...cars, ...policeCars].forEach(car => {
                        if (car.speed > 2) {
                            const dx = car.x - player.x;
                            const dy = car.y - player.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            
                            if (dist < 25) {
                                const damage = Math.floor(car.speed * 10);
                                if (player.armor > 0) {
                                    player.armor = Math.max(0, player.armor - damage);
                                } else {
                                    player.health -= damage;
                                }
                                player.invulnerableTime = 30;
                                
                                // –û—Ç–±—Ä–∞—Å—ã–≤–∞–Ω–∏–µ
                                const pushAngle = Math.atan2(dy, dx);
                                player.x -= Math.cos(pushAngle) * 20;
                                player.y -= Math.sin(pushAngle) * 20;
                            }
                        }
                    });
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                const targetCameraX = player.x - canvas.width / 2;
                const targetCameraY = player.y - canvas.height / 2;
                
                game.camera.x += (targetCameraX - game.camera.x) * 0.1;
                game.camera.y += (targetCameraY - game.camera.y) * 0.1;
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                game.camera.x = Math.max(0, Math.min(game.mapWidth - canvas.width, game.camera.x));
                game.camera.y = Math.max(0, Math.min(game.mapHeight - canvas.height, game.camera.y));
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º—ã—à–∏
                mouseWorldX = mouseX + game.camera.x;
                mouseWorldY = mouseY + game.camera.y;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω
                cars.forEach(car => car.update());
                policeCars.forEach(car => car.update());
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏—Ö
                for (let i = policemen.length - 1; i >= 0; i--) {
                    policemen[i].update();
                    if (policemen[i].isDead) {
                        if (!policemen[i].deathTimer) {
                            policemen[i].deathTimer = 300;
                        }
                        policemen[i].deathTimer--;
                        if (policemen[i].deathTimer <= 0) {
                            policemen.splice(i, 1);
                        }
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—à–µ—Ö–æ–¥–æ–≤
                pedestrians.forEach(ped => ped.update());
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–ª–µ–Ω–æ–≤ –±–∞–Ω–¥
                gangMembers.forEach(gang => gang.update());
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∏–∫–∞–ø–æ–≤
                for (let i = pickups.length - 1; i >= 0; i--) {
                    pickups[i].update();
                    if (pickups[i].collected) {
                        pickups.splice(i, 1);
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–ª—å
                for (let i = bullets.length - 1; i >= 0; i--) {
                    bullets[i].update();
                    if (bullets[i].isOffScreen()) {
                        bullets.splice(i, 1);
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    if (particles[i].life <= 0) {
                        particles.splice(i, 1);
                    }
                }
                
                // –†–µ—Å–ø–∞–≤–Ω –ø–µ—à–µ—Ö–æ–¥–æ–≤
                if (pedestrians.filter(p => !p.isDead).length < maxPedestrians && Math.random() < 0.02) {
                    pedestrians.push(new Pedestrian(
                        Math.random() * game.mapWidth,
                        Math.random() * game.mapHeight
                    ));
                }
                
                // –†–µ—Å–ø–∞–≤–Ω —á–ª–µ–Ω–æ–≤ –±–∞–Ω–¥
                if (gangMembers.filter(g => !g.isDead).length < maxGangMembers && Math.random() < 0.01) {
                    const gangKeys = Object.keys(gangs);
                    const randomGang = gangKeys[Math.floor(Math.random() * gangKeys.length)];
                    const district = districts[gangs[randomGang].territory];
                    
                    gangMembers.push(new GangMember(
                        district.x + Math.random() * district.width,
                        district.y + Math.random() * district.height,
                        randomGang
                    ));
                }
                
                // –û—á–∏—Å—Ç–∫–∞ –º–µ—Ä—Ç–≤—ã—Ö
                if (Math.random() < 0.01) {
                    for (let i = pedestrians.length - 1; i >= 0; i--) {
                        if (pedestrians[i].isDead) {
                            pedestrians.splice(i, 1);
                        }
                    }
                    
                    for (let i = gangMembers.length - 1; i >= 0; i--) {
                        if (gangMembers[i].isDead) {
                            if (!gangMembers[i].deathTimer) {
                                gangMembers[i].deathTimer = 300;
                            }
                            gangMembers[i].deathTimer--;
                            if (gangMembers[i].deathTimer <= 0) {
                                gangMembers.splice(i, 1);
                            }
                        }
                    }
                }
                
                // –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–æ–∑—ã—Å–∫–∞
                if (Math.random() < 0.002 && player.wantedLevel > 0) {
                    player.wantedLevel--;
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                document.getElementById('health').textContent = player.health;
                document.getElementById('armor').textContent = player.armor;
                document.getElementById('money').textContent = player.money;
                const stars = '‚òÖ'.repeat(player.wantedLevel) + '‚òÜ'.repeat(5 - player.wantedLevel);
                document.getElementById('wanted').textContent = stars;
                
                const weapon = weapons[player.currentWeapon];
                document.getElementById('weapon').textContent = weapon.name;
                document.getElementById('ammo').textContent = 
                    player.weapons[player.currentWeapon].ammo === Infinity ? '‚àû' : player.weapons[player.currentWeapon].ammo;
                
                document.getElementById('location').textContent = getCurrentDistrict();
                
                // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ (600 –∫–∞–¥—Ä–æ–≤ –ø—Ä–∏ 60 FPS)
                if (!window.saveCounter) window.saveCounter = 0;
                window.saveCounter++;
                if (window.saveCounter >= 600) {
                    savePlayerData();
                    window.saveCounter = 0;
                }
            }
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            function draw() {
                // –§–æ–Ω - —Ä–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞–π–æ–Ω–æ–≤
                ctx.fillStyle = '#2a2a2a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–∞–π–æ–Ω–æ–≤
                for (let key in districts) {
                    const district = districts[key];
                    const screenX = district.x - game.camera.x;
                    const screenY = district.y - game.camera.y;
                    
                    if (screenX < canvas.width && screenY < canvas.height &&
                        screenX + district.width > 0 && screenY + district.height > 0) {
                        ctx.fillStyle = district.color;
                        ctx.fillRect(screenX, screenY, district.width, district.height);
                    }
                }
                
                // –î–æ—Ä–æ–∂–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞
                ctx.strokeStyle = '#555';
                ctx.lineWidth = 2;
                ctx.setLineDash([20, 20]);
                
                for (let x = -game.camera.x % game.tileSize; x < canvas.width; x += game.tileSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (let y = -game.camera.y % game.tileSize; y < canvas.height; y += game.tileSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                ctx.setLineDash([]);
                
                // –ó–¥–∞–Ω–∏—è
                buildings.forEach(building => {
                    const screenX = building.x - game.camera.x;
                    const screenY = building.y - game.camera.y;
                    
                    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ –∑–¥–∞–Ω–∏—è
                    if (screenX + building.width > 0 && screenX < canvas.width &&
                        screenY + building.height > 0 && screenY < canvas.height) {
                        
                        // –¢–µ–Ω—å –∑–¥–∞–Ω–∏—è
                        ctx.fillStyle = 'rgba(0,0,0,0.4)';
                        ctx.fillRect(screenX + 5, screenY + 5, building.width, building.height);
                        
                        // –ó–¥–∞–Ω–∏–µ
                        ctx.fillStyle = building.color;
                        ctx.fillRect(screenX, screenY, building.width, building.height);
                        
                        // –û–∫–Ω–∞
                        ctx.fillStyle = 'rgba(255,255,200,0.3)';
                        const windowSize = 10;
                        const windowGap = 20;
                        
                        for (let wx = screenX + 10; wx < screenX + building.width - 10; wx += windowGap) {
                            for (let wy = screenY + 10; wy < screenY + building.height - 10; wy += windowGap) {
                                ctx.fillRect(wx, wy, windowSize, windowSize);
                            }
                        }
                    }
                });
                
                // –ü–∏–∫–∞–ø—ã
                pickups.forEach(pickup => pickup.draw());
                
                // –ß–∞—Å—Ç–∏—Ü—ã
                particles.forEach(particle => particle.draw());
                
                // –ü–µ—à–µ—Ö–æ–¥—ã
                pedestrians.forEach(ped => {
                    if (Math.abs(ped.x - player.x) < 500 && Math.abs(ped.y - player.y) < 400) {
                        ped.draw();
                    }
                });
                
                // –ß–ª–µ–Ω—ã –±–∞–Ω–¥
                gangMembers.forEach(gang => {
                    if (Math.abs(gang.x - player.x) < 600 && Math.abs(gang.y - player.y) < 500) {
                        gang.draw();
                    }
                });
                
                // –ú–∞—à–∏–Ω—ã
                cars.forEach(car => {
                    if (Math.abs(car.x - player.x) < 500 && Math.abs(car.y - player.y) < 400) {
                        car.draw();
                    }
                });
                
                policeCars.forEach(car => {
                    if (Math.abs(car.x - player.x) < 600 && Math.abs(car.y - player.y) < 500) {
                        car.draw();
                    }
                });
                
                // –ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–µ
                policemen.forEach(cop => cop.draw());
                
                // –ò–≥—Ä–æ–∫
                if (!player.inCar && !player.isDead) {
                    // –ú–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç–∏
                    if (player.invulnerableTime <= 0 || Math.floor(player.invulnerableTime / 5) % 2 === 0) {
                        const playerPerson = new Person(player.x, player.y, '#ff9900');
                        playerPerson.angle = player.angle;
                        playerPerson.health = player.health;
                        playerPerson.maxHealth = player.maxHealth;
                        playerPerson.armor = player.armor;
                        playerPerson.drawPerson(true);
                    }
                }
                
                // –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ (–º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä)
                otherPlayers.forEach((otherPlayer, playerId) => {
                    if (!otherPlayer.inCar && !otherPlayer.isDead) {
                        const otherPlayerPerson = new Person(otherPlayer.x, otherPlayer.y, '#00ff00');
                        otherPlayerPerson.angle = otherPlayer.angle || 0;
                        otherPlayerPerson.health = otherPlayer.health || 100;
                        otherPlayerPerson.maxHealth = otherPlayer.maxHealth || 100;
                        otherPlayerPerson.armor = otherPlayer.armor || 0;
                        otherPlayerPerson.drawPerson(false);
                        
                        // –ò–º—è –∏–≥—Ä–æ–∫–∞ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π
                        ctx.save();
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`Player ${playerId.substring(0, 6)}`, 
                                   otherPlayer.x - game.camera.x, 
                                   otherPlayer.y - game.camera.y - 25);
                        ctx.restore();
                    }
                });
                
                // –ü—É–ª–∏
                bullets.forEach(bullet => bullet.draw());
                
                // –°–µ—Ç–µ–≤—ã–µ –ø—É–ª–∏ (–º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä)
                networkBullets.forEach(bullet => {
                    ctx.save();
                    ctx.fillStyle = bullet.color || '#ffff00';
                    ctx.beginPath();
                    ctx.arc(bullet.x - game.camera.x, bullet.y - game.camera.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
                
                // –ü—Ä–∏—Ü–µ–ª (—Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ –≤ –º–∞—à–∏–Ω–µ)
                if (!player.inCar && !player.isDead) {
                    let targetX, targetY;
                    
                    if (isMobile && (touchAiming.x !== 0 || touchAiming.y !== 0)) {
                        // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Å –∞–∫—Ç–∏–≤–Ω—ã–º –¥–∂–æ–π—Å—Ç–∏–∫–æ–º –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
                        const aimDistance = 100; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏—Ü–µ–ª–∞ –æ—Ç –∏–≥—Ä–æ–∫–∞
                        targetX = (player.x - game.camera.x) + touchAiming.x * aimDistance;
                        targetY = (player.y - game.camera.y) + touchAiming.y * aimDistance;
                    } else if (!isMobile) {
                        // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º—ã—à—å
                        targetX = mouseX;
                        targetY = mouseY;
                    } else {
                        // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º –±–µ–∑ –¥–∂–æ–π—Å—Ç–∏–∫–∞ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
                        const aimDistance = 100;
                        targetX = (player.x - game.camera.x) + Math.cos(player.angle) * aimDistance;
                        targetY = (player.y - game.camera.y) + Math.sin(player.angle) * aimDistance;
                    }
                    
                    // –†–∏—Å—É–µ–º –ø—Ä–∏—Ü–µ–ª
                    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(targetX - 10, targetY);
                    ctx.lineTo(targetX + 10, targetY);
                    ctx.moveTo(targetX, targetY - 10);
                    ctx.lineTo(targetX, targetY + 10);
                    ctx.stroke();
                    
                    // –õ–∏–Ω–∏—è –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
                    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(player.x - game.camera.x, player.y - game.camera.y);
                    ctx.lineTo(targetX, targetY);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // –≠–∫—Ä–∞–Ω —Å–º–µ—Ä—Ç–∏
                if (player.isDead) {
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 48px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('–ü–û–¢–†–ê–ß–ï–ù–û', canvas.width/2, canvas.height/2);
                    
                    ctx.font = '24px Arial';
                    ctx.fillText(`–†–µ—Å–ø–∞–≤–Ω —á–µ—Ä–µ–∑ ${Math.ceil(player.respawnTimer / 60)} —Å–µ–∫...`, canvas.width/2, canvas.height/2 + 50);
                }
                
                // –ü–æ–ª–æ—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞
                const healthBarWidth = 200;
                const healthBarHeight = 20;
                const healthBarX = canvas.width/2 - healthBarWidth/2;
                const healthBarY = canvas.height - 40;
                
                // –§–æ–Ω –ø–æ–ª–æ—Å—ã –∑–¥–æ—Ä–æ–≤—å—è
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(healthBarX - 2, healthBarY - 2, healthBarWidth + 4, healthBarHeight + 4);
                
                // –ü–æ–ª–æ—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è
                const healthPercent = Math.max(0, player.health / player.maxHealth);
                ctx.fillStyle = healthPercent > 0.3 ? '#44ff44' : '#ff4444';
                ctx.fillRect(healthBarX, healthBarY, healthBarWidth * healthPercent, healthBarHeight);
                
                // –ü–æ–ª–æ—Å–∞ –±—Ä–æ–Ω–∏
                if (player.armor > 0) {
                    const armorPercent = player.armor / player.maxArmor;
                    ctx.fillStyle = '#4444ff';
                    ctx.fillRect(healthBarX, healthBarY - 10, healthBarWidth * armorPercent, 6);
                }
                
                // –†–∞–º–∫–∞
                ctx.strokeStyle = '#ffffff';
                ctx.strokeRect(healthBarX, healthBarY, healthBarWidth, healthBarHeight);
                
                // –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞
                const minimapSize = 100;
                const minimapX = canvas.width - minimapSize - 10;
                const minimapY = 10;
                
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(minimapX, minimapY, minimapSize, minimapSize);
                
                // –†–∞–π–æ–Ω—ã –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ
                for (let key in districts) {
                    const district = districts[key];
                    ctx.fillStyle = district.color;
                    ctx.globalAlpha = 0.5;
                    ctx.fillRect(
                        minimapX + (district.x / game.mapWidth) * minimapSize,
                        minimapY + (district.y / game.mapHeight) * minimapSize,
                        (district.width / game.mapWidth) * minimapSize,
                        (district.height / game.mapHeight) * minimapSize
                    );
                }
                ctx.globalAlpha = 1;
                
                ctx.strokeStyle = '#666';
                ctx.strokeRect(minimapX, minimapY, minimapSize, minimapSize);
                
                // –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞ –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(
                    minimapX + (player.x / game.mapWidth) * minimapSize - 2,
                    minimapY + (player.y / game.mapHeight) * minimapSize - 2,
                    4,
                    4
                );
                
                // –ü–æ–ª–∏—Ü–∏—è –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–æ–∑—ã—Å–∫)
                if (player.wantedLevel > 0) {
                    ctx.fillStyle = '#0000ff';
                    [...policeCars, ...policemen].forEach(cop => {
                        if (cop && !cop.isDead) {
                            ctx.fillRect(
                                minimapX + (cop.x / game.mapWidth) * minimapSize - 1,
                                minimapY + (cop.y / game.mapHeight) * minimapSize - 1,
                                2,
                                2
                            );
                        }
                    });
                }
                
                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ—Ä—É–∂–∏—é
                if (player.weapons.uzi.unlocked || player.weapons.shotgun.unlocked || player.weapons.rifle.unlocked) {
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    let y = 150;
                    
                    if (player.weapons.pistol.unlocked) {
                        ctx.fillText('1 - –ü–∏—Å—Ç–æ–ª–µ—Ç', 10, y);
                        y += 15;
                    }
                    if (player.weapons.uzi.unlocked) {
                        ctx.fillText('2 - –£–∑–∏', 10, y);
                        y += 15;
                    }
                    if (player.weapons.shotgun.unlocked) {
                        ctx.fillText('3 - –î—Ä–æ–±–æ–≤–∏–∫', 10, y);
                        y += 15;
                    }
                }
            }
            
            // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            function gameLoop() {
                update();
                draw();
                requestAnimationFrame(gameLoop);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.addEventListener('keydown', (e) => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–ª–∞–≤–∏—à
                keys[e.key] = true;
                keys[e.key.toLowerCase()] = true;
                keys[e.key.toUpperCase()] = true;
                keys[e.code] = true;
                
                // –°–º–µ–Ω–∞ –æ—Ä—É–∂–∏—è
                if (!player.isDead && !player.inCar) {
                    if ((e.key === '1' || e.code === 'Digit1') && player.weapons.pistol.unlocked) {
                        player.currentWeapon = 'pistol';
                    } else if ((e.key === '2' || e.code === 'Digit2') && player.weapons.uzi.unlocked) {
                        player.currentWeapon = 'uzi';
                    } else if ((e.key === '3' || e.code === 'Digit3') && player.weapons.shotgun.unlocked) {
                        player.currentWeapon = 'shotgun';
                    }
                }
                
                // –í—Ö–æ–¥/–≤—ã—Ö–æ–¥ –∏–∑ –º–∞—à–∏–Ω—ã
                if ((e.key.toLowerCase() === 'e' || e.code === 'KeyE') && !e.repeat) {
                    if (player.inCar) {
                        // –í—ã—Ö–æ–¥
                        player.inCar = null;
                    } else {
                        // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π –º–∞—à–∏–Ω—ã
                        let nearestCar = null;
                        let minDist = 40;
                        
                        [...cars, ...policeCars].forEach(car => {
                            const dx = car.x - player.x;
                            const dy = car.y - player.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            
                            if (dist < minDist) {
                                minDist = dist;
                                nearestCar = car;
                            }
                        });
                        
                        if (nearestCar) {
                            player.inCar = nearestCar;
                        }
                    }
                }
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                e.preventDefault();
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.key] = false;
                keys[e.key.toLowerCase()] = false;
                keys[e.key.toUpperCase()] = false;
                keys[e.code] = false;
            });
            
            // –°–æ–±—ã—Ç–∏—è –º—ã—à–∏
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('click', (e) => {
                if (!player.isDead && !player.inCar && player.shootCooldown <= 0) {
                    const weapon = weapons[player.currentWeapon];
                    const angle = Math.atan2(mouseWorldY - player.y, mouseWorldX - player.x);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç—Ä–æ–Ω–æ–≤
                    if (player.weapons[player.currentWeapon].ammo === 0) {
                        return;
                    }
                    
                    if (weapon.pellets) {
                        // –î—Ä–æ–±–æ–≤–∏–∫ - –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—É–ª—å
                        for (let i = 0; i < weapon.pellets; i++) {
                            const spread = (Math.random() - 0.5) * 0.3;
                            bullets.push(new Bullet(
                                player.x + Math.cos(angle) * 15,
                                player.y + Math.sin(angle) * 15,
                                angle + spread,
                                true,
                                weapon.damage,
                                weapon.bulletSpeed,
                                weapon.color
                            ));
                        }
                    } else {
                        // –û–±—ã—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ
                        bullets.push(new Bullet(
                            player.x + Math.cos(angle) * 15,
                            player.y + Math.sin(angle) * 15,
                            angle,
                            true,
                            weapon.damage,
                            weapon.bulletSpeed,
                            weapon.color
                        ));
                    }
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã—Å—Ç—Ä–µ–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    sendToServer({
                        type: 'shoot',
                        x: player.x + Math.cos(angle) * 15,
                        y: player.y + Math.sin(angle) * 15,
                        angle: angle,
                        damage: weapon.damage
                    });
                    
                    // –†–∞—Å—Ö–æ–¥ –ø–∞—Ç—Ä–æ–Ω–æ–≤
                    if (player.weapons[player.currentWeapon].ammo !== Infinity) {
                        player.weapons[player.currentWeapon].ammo--;
                    }
                    
                    player.shootCooldown = weapon.fireRate;
                }
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–µ–ª—å–±–∞ –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏
            let mouseDown = false;
            canvas.addEventListener('mousedown', () => mouseDown = true);
            canvas.addEventListener('mouseup', () => mouseDown = false);
            
            setInterval(() => {
                if (mouseDown && !player.isDead && !player.inCar && player.shootCooldown <= 0) {
                    canvas.dispatchEvent(new Event('click'));
                }
            }, 50);
            
            // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (isMobile) {
                // –î–∂–æ–π—Å—Ç–∏–∫
                const joystick = document.getElementById('joystick');
                const joystickBase = document.getElementById('joystickBase');
                const joystickKnob = document.getElementById('joystickKnob');
                let joystickActive = false;
                let joystickStartX = 0;
                let joystickStartY = 0;
                let joystickTouchId = null;
                
                function handleJoystickStart(e) {
                    e.preventDefault();
                    joystickActive = true;
                    const touch = e.touches ? e.touches[0] : e;
                    joystickTouchId = touch.identifier || 0;
                    const rect = joystickBase.getBoundingClientRect();
                    joystickStartX = rect.left + rect.width / 2;
                    joystickStartY = rect.top + rect.height / 2;
                    handleJoystickMove(e);
                }
                
                function handleJoystickMove(e) {
                    if (!joystickActive) return;
                    e.preventDefault();
                    
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = touch.clientX - joystickStartX;
                    const deltaY = touch.clientY - joystickStartY;
                    
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    const maxDistance = 40;
                    
                    if (distance > maxDistance) {
                        const angle = Math.atan2(deltaY, deltaX);
                        touchMovement.x = Math.cos(angle);
                        touchMovement.y = Math.sin(angle);
                        joystickKnob.style.transform = `translate(${Math.cos(angle) * maxDistance - 20}px, ${Math.sin(angle) * maxDistance - 20}px)`;
                    } else {
                        touchMovement.x = deltaX / maxDistance;
                        touchMovement.y = deltaY / maxDistance;
                        joystickKnob.style.transform = `translate(${deltaX - 20}px, ${deltaY - 20}px)`;
                    }
                }
                
                function handleJoystickEnd() {
                    joystickActive = false;
                    touchMovement.x = 0;
                    touchMovement.y = 0;
                    joystickKnob.style.transform = 'translate(-20px, -20px)';
                }
                
                joystick.addEventListener('touchstart', handleJoystickStart);
                joystick.addEventListener('touchmove', handleJoystickMove);
                joystick.addEventListener('touchend', handleJoystickEnd);
                
                // –î–∂–æ–π—Å—Ç–∏–∫ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
                const aimJoystick = document.getElementById('aimJoystick');
                const aimJoystickBase = document.getElementById('aimJoystickBase');
                const aimJoystickKnob = document.getElementById('aimJoystickKnob');
                let aimJoystickActive = false;
                let aimJoystickStartX = 0;
                let aimJoystickStartY = 0;
                let aimJoystickTouchId = null;
                
                function handleAimJoystickStart(e) {
                    e.preventDefault();
                    aimJoystickActive = true;
                    const touch = e.touches ? e.touches[0] : e;
                    aimJoystickTouchId = touch.identifier || 0;
                    const rect = aimJoystickBase.getBoundingClientRect();
                    aimJoystickStartX = rect.left + rect.width / 2;
                    aimJoystickStartY = rect.top + rect.height / 2;
                    handleAimJoystickMove(e);
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º —Å—Ç—Ä–µ–ª—å–±—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –¥–∂–æ–π—Å—Ç–∏–∫ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
                    startShooting();
                }
                
                function handleAimJoystickMove(e) {
                    if (!aimJoystickActive) return;
                    e.preventDefault();
                    
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = touch.clientX - aimJoystickStartX;
                    const deltaY = touch.clientY - aimJoystickStartY;
                    
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    const maxDistance = 40;
                    
                    if (distance > maxDistance) {
                        const angle = Math.atan2(deltaY, deltaX);
                        touchAiming.x = Math.cos(angle);
                        touchAiming.y = Math.sin(angle);
                        aimJoystickKnob.style.transform = `translate(${Math.cos(angle) * maxDistance - 20}px, ${Math.sin(angle) * maxDistance - 20}px)`;
                    } else {
                        touchAiming.x = deltaX / maxDistance;
                        touchAiming.y = deltaY / maxDistance;
                        aimJoystickKnob.style.transform = `translate(${deltaX - 20}px, ${deltaY - 20}px)`;
                    }
                }
                
                function handleAimJoystickEnd() {
                    aimJoystickActive = false;
                    touchAiming.x = 0;
                    touchAiming.y = 0;
                    aimJoystickKnob.style.transform = 'translate(-20px, -20px)';
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª—å–±—É –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
                    stopShooting();
                }
                
                aimJoystick.addEventListener('touchstart', handleAimJoystickStart);
                aimJoystick.addEventListener('touchmove', handleAimJoystickMove);
                aimJoystick.addEventListener('touchend', handleAimJoystickEnd);
                
                // –§—É–Ω–∫—Ü–∏–∏ —Å—Ç—Ä–µ–ª—å–±—ã –¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
                let shootInterval;
                
                function startShooting() {
                    function shoot() {
                        if (!player.isDead && !player.inCar && player.shootCooldown <= 0) {
                            const weapon = weapons[player.currentWeapon];
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç—Ä–æ–Ω–æ–≤
                            if (player.weapons[player.currentWeapon].ammo === 0) {
                                return;
                            }
                            
                            // –°—Ç—Ä–µ–ª—è–µ–º –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è –∏–ª–∏ –¥–≤–∏–∂–µ–Ω–∏—è
                            let angle;
                            if (touchAiming.x !== 0 || touchAiming.y !== 0) {
                                angle = Math.atan2(touchAiming.y, touchAiming.x);
                            } else {
                                angle = player.angle;
                            }
                            
                            if (weapon.pellets) {
                                // –î—Ä–æ–±–æ–≤–∏–∫
                                for (let i = 0; i < weapon.pellets; i++) {
                                    const spread = (Math.random() - 0.5) * 0.3;
                                    bullets.push(new Bullet(
                                        player.x + Math.cos(angle) * 15,
                                        player.y + Math.sin(angle) * 15,
                                        angle + spread,
                                        true,
                                        weapon.damage,
                                        weapon.bulletSpeed,
                                        weapon.color
                                    ));
                                }
                            } else {
                                bullets.push(new Bullet(
                                    player.x + Math.cos(angle) * 15,
                                    player.y + Math.sin(angle) * 15,
                                    angle,
                                    true,
                                    weapon.damage,
                                    weapon.bulletSpeed,
                                    weapon.color
                                ));
                            }
                            
                            // –†–∞—Å—Ö–æ–¥ –ø–∞—Ç—Ä–æ–Ω–æ–≤
                            if (player.weapons[player.currentWeapon].ammo !== Infinity) {
                                player.weapons[player.currentWeapon].ammo--;
                            }
                            
                            player.shootCooldown = weapon.fireRate;
                        }
                    }
                    
                    shoot();
                    shootInterval = setInterval(shoot, 100);
                }
                
                function stopShooting() {
                    clearInterval(shootInterval);
                }
                
                // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (E)
                const actionButton = document.getElementById('actionButton');
                actionButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    
                    if (player.inCar) {
                        // –í—ã—Ö–æ–¥ –∏–∑ –º–∞—à–∏–Ω—ã
                        player.inCar = null;
                    } else {
                        // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π –º–∞—à–∏–Ω—ã
                        let nearestCar = null;
                        let minDist = 40;
                        
                        [...cars, ...policeCars].forEach(car => {
                            const dx = car.x - player.x;
                            const dy = car.y - player.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            
                            if (dist < minDist) {
                                minDist = dist;
                                nearestCar = car;
                            }
                        });
                        
                        if (nearestCar) {
                            player.inCar = nearestCar;
                        }
                    }
                });
                
                // –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã –æ—Ä—É–∂–∏—è
                const weaponButton = document.getElementById('weaponButton');
                weaponButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    
                    // –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ –æ—Ä—É–∂–∏—è
                    const weaponList = ['pistol', 'uzi', 'shotgun', 'rifle'];
                    const unlockedWeapons = weaponList.filter(w => player.weapons[w].unlocked);
                    
                    if (unlockedWeapons.length > 1) {
                        const currentIndex = unlockedWeapons.indexOf(player.currentWeapon);
                        const nextIndex = (currentIndex + 1) % unlockedWeapons.length;
                        player.currentWeapon = unlockedWeapons[nextIndex];
                    }
                });
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
                document.addEventListener('contextmenu', (e) => e.preventDefault());
            }
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ canvas
            function resizeCanvas() {
                const container = document.getElementById('gameContainer');
                let containerWidth = container.clientWidth;
                let containerHeight = container.clientHeight;
                
                // –£—á–∏—Ç—ã–≤–∞–µ–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Telegram Web App
                if (tg && tg.viewportHeight) {
                    containerHeight = Math.min(containerHeight, tg.viewportHeight);
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º canvas –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                canvas.width = containerWidth;
                canvas.height = containerHeight;
                canvas.style.width = containerWidth + 'px';
                canvas.style.height = containerHeight + 'px';
            }
            
            window.addEventListener('resize', resizeCanvas);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è viewport –≤ Telegram
            if (tg) {
                tg.onEvent('viewportChanged', resizeCanvas);
            }
            
            resizeCanvas();
            
            // –§–æ–∫—É—Å –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–µ
            document.body.focus();
            
            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
            init();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
            loadPlayerData();
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞
            connectToServer();
            
            gameLoop();
        });
    </script>
</body>
</html>
